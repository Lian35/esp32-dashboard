<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP32 IoT Dashboard</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<style>
body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(135deg,#667eea,#764ba2);
  padding:20px;
}
.container { max-width:1200px; margin:auto; }
.card {
  background:white;
  padding:20px;
  border-radius:15px;
  box-shadow:0 5px 15px rgba(0,0,0,.1);
}
.grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:20px;
}
.value {
  font-size:3rem;
  font-weight:700;
}
.status {
  display:flex;
  align-items:center;
  gap:8px;
}
.dot {
  width:10px;
  height:10px;
  border-radius:50%;
  background:gray;
}
button {
  padding:10px 20px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
}
footer {
  text-align:center;
  margin-top:30px;
  color:white;
}
</style>
</head>

<body>
<div class="container">

<div class="card">
  <h1><i class="fas fa-microchip"></i> ESP32 IoT Dashboard</h1>
  <div class="status">
    <span class="dot" id="dot"></span>
    <span id="status">Conectandoâ€¦</span>
    <span id="time"></span>
  </div>
  <br>
  <button onclick="fetchData()">ğŸ”„ Actualizar ahora</button>
</div>

<br>

<div class="grid">
  <div class="card">
    <h3>ğŸŒ¡ï¸ Temperatura (ThingSpeak)</h3>
    <div class="value"><span id="temp">--</span> Â°C</div>
  </div>

  <div class="card">
    <h3>ğŸ’§ Humedad (ThingSpeak)</h3>
    <div class="value"><span id="hum">--</span> %</div>
  </div>
</div>

<br>

<div class="card">
  <h3>ğŸ“ˆ HistÃ³rico REAL de Temperatura</h3>
  <div id="chart"></div>
</div>

<footer>
<p>ESP32 â†’ ThingSpeak â†’ GitHub Pages (ActualizaciÃ³n cada 15 s)</p>
</footer>

</div>

<script>
// ================= CONFIG =================
const CHANNEL_ID = 3229390;
const READ_API_KEY = "IOUT49G2VKRMTKID";
const REFRESH_TIME = 15000; // 15 segundos (recomendado)

// ================= DOM =================
const tempEl = document.getElementById("temp");
const humEl = document.getElementById("hum");
const statusEl = document.getElementById("status");
const dotEl = document.getElementById("dot");
const timeEl = document.getElementById("time");

// ================= CHART =================
const chart = new ApexCharts(document.querySelector("#chart"), {
  chart: { type: 'line', height: 300, animations: { enabled: true } },
  series: [{ name: "Temperatura (Â°C)", data: [] }],
  xaxis: { type: 'datetime' }
});
chart.render();

// ================= FETCH =================
async function fetchData(){
  try {
    const res = await fetch(
      `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_API_KEY}&results=20`
    );
    const json = await res.json();
    const feeds = json.feeds;

    if (!feeds || feeds.length === 0) throw "Sin datos";

    const last = feeds[feeds.length - 1];
    const temp = parseFloat(last.field1);
    const hum = parseFloat(last.field2);

    tempEl.textContent = temp.toFixed(1);
    humEl.textContent = hum.toFixed(1);

    timeEl.textContent = "Ãšltima lectura: " +
      new Date(last.created_at).toLocaleTimeString();

    statusEl.textContent = "ESP32 Online";
    dotEl.style.background = "green";

    const chartData = feeds
      .filter(f => f.field1)
      .map(f => [new Date(f.created_at).getTime(), parseFloat(f.field1)]);

    chart.updateSeries([{ data: chartData }]);

  } catch (e) {
    statusEl.textContent = "Sin conexiÃ³n";
    dotEl.style.background = "red";
  }
}

// ================= START =================
fetchData();                       // Carga inicial
setInterval(fetchData, REFRESH_TIME); // Tiempo real controlado
</script>
</body>
</html>
